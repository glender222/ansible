---
# ğŸ“¦ PLAYBOOK: PROVISIONING EN VMs
# Incluido desde main.yml cuando mode=provisioning
# 
# Tareas:
# - Obtener VMs desde vCenter
# - Esperar conectividad
# - Incluir roles de provisioning
# - Validar deployment

- name: "ğŸ“¦ PROVISIONING EN MÃQUINAS VIRTUALES"
  hosts: localhost
  connection: local
  gather_facts: no
  
  vars:
    vcenter_hostname: "{{ vault_vcenter.hostname }}"
    vcenter_port: "{{ vault_vcenter.port }}"
    vcenter_username: "{{ vault_vcenter.username }}"
    vcenter_password: "{{ vault_vcenter.password }}"
    vcenter_validate_certs: "{{ vault_vcenter.validate_certs }}"
  
  tasks:
    # ğŸ“¡ Obtener VMs de vCenter
    - name: "ğŸ“¡ Obtener lista de VMs"
      community.vmware.vmware_vm_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        port: "{{ vcenter_port }}"
        validate_certs: "{{ vcenter_validate_certs }}"
      register: vms_info
      tags:
        - provisioning
        - always
    
    # ğŸ§ Filtrar VMs Linux activas
    - name: "ğŸ§ Filtrar VMs Linux activas"
      set_fact:
        active_linux_vms: "{{ vms_info.virtual_machines | selectattr('guest_fullname', 'match', '.*Linux.*') | selectattr('power_state', 'equalto', 'poweredOn') | list }}"
      tags:
        - provisioning
        - linux
    
    # ğŸªŸ Filtrar VMs Windows activas
    - name: "ğŸªŸ Filtrar VMs Windows activas"
      set_fact:
        active_windows_vms: "{{ vms_info.virtual_machines | selectattr('guest_fullname', 'match', '.*Windows.*') | selectattr('power_state', 'equalto', 'poweredOn') | list }}"
      tags:
        - provisioning
        - windows
    
    # ğŸ“‹ Mostrar VMs para provisioning
    - name: "ğŸ“‹ VMs disponibles para provisioning"
      debug:
        msg: |
          ğŸ§ Linux ({{ active_linux_vms | length }}):
          {% for vm in active_linux_vms %}
          â€¢ {{ vm.guest_name }} ({{ vm.ip_address | default('Sin IP') }})
          {% endfor %}
          
          ğŸªŸ Windows ({{ active_windows_vms | length }}):
          {% for vm in active_windows_vms %}
          â€¢ {{ vm.guest_name }} ({{ vm.ip_address | default('Sin IP') }})
          {% endfor %}
      tags:
        - provisioning
        - always
    
    # ğŸ’¡ InformaciÃ³n de Provisioning
    - name: "ğŸ’¡ InformaciÃ³n de Provisioning"
      debug:
        msg: |
          â„¹ï¸  PROVISIONING - PRÃ“XIMOS PASOS:
          
          âœ“ Para provisioning en VMs Linux:
            1. Asegurar conectividad SSH
            2. Usar roles Galaxy (geerlingguy.*, robertdebock.*)
            3. Usar inventario dinÃ¡mico
          
          âœ“ Para provisioning en VMs Windows:
            1. Habilitar WinRM en VMs Windows
            2. Usar ansible.windows roles
            3. Configurar autenticaciÃ³n
          
          âœ“ Roles Galaxy disponibles:
            â€¢ geerlingguy.nginx v3.2.0
            â€¢ geerlingguy.docker v4.9
            â€¢ geerlingguy.security v3.0.0
            â€¢ robertdebock.users v6.1.6
            â€¢ robertdebock.service v3.1.11
            â€¢ linux-system-roles.storage v1.18.20
            â€¢ linux-system-roles.sudo v1.2.6
          
          ğŸ“š PrÃ³xima fase: Integrar roles segÃºn necesidad
      tags:
        - provisioning
        - always