---
# ğŸ”Œ TAREAS: GESTIÃ“N DE VCENTER/ESXI
# Incluido desde main.yml cuando mode=vmware
# 
# Tareas:
# - Obtener credenciales desde HashiCorp Vault
# - Conectar a vCenter/ESXi
# - Obtener lista de VMs
# - Clasificar VMs por SO
# - Mostrar informaciÃ³n
# - Validar estado

# ğŸ”‘ Obtener credenciales desde Vault
- name: "ğŸ”‘ Obtener credenciales de vCenter desde Vault"
  set_fact:
    vault_vcenter: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=secret/data/vcenter url=' + vault_addr + ' token=' + vault_token) }}"

# ğŸ“¡ Conectar a vCenter/ESXi
- name: "ğŸ“¡ Conectando a vCenter/ESXi..."
  debug:
    msg: "Conectando a {{ vault_vcenter.hostname }}:{{ vault_vcenter.port }} (ESXi: {{ vault_vcenter.esxi_hostname_fqdn }})"
  tags:
    - vcenter
    - always
    
# ğŸ“‹ Obtener lista de VMs
- name: "ğŸ“‹ Obtener todas las VMs de vCenter/ESXi"
  community.vmware.vmware_vm_info:
    hostname: "{{ vault_vcenter.hostname }}"
    username: "{{ vault_vcenter.username }}"
    password: "{{ vault_vcenter.password }}"
    port: "{{ vault_vcenter.port }}"
    validate_certs: "{{ vault_vcenter.validate_certs }}"
  register: vms_info
  tags:
    - vcenter
    - vm-list
    
    # ğŸ¯ Clasificar VMs por SO
- name: "ğŸ¯ Clasificar VMs por Sistema Operativo"
  set_fact:
    linux_vms: "{{ vms_info.virtual_machines | selectattr('guest_fullname', 'match', '.*Linux.*') | list }}"
    windows_vms: "{{ vms_info.virtual_machines | selectattr('guest_fullname', 'match', '.*Windows.*') | list }}"
    other_vms: "{{ vms_info.virtual_machines | rejectattr('guest_fullname', 'match', '.*Linux.*') | rejectattr('guest_fullname', 'match', '.*Windows.*') | list }}"
  tags:
    - vcenter
    - vm-classification
    
    # ğŸ§ Mostrar VMs Linux
- name: "ğŸ§ VMs LINUX"
  debug:
    msg: |
      Nombre: {{ item.guest_name }}
      SO: {{ item.guest_fullname }}
      Estado: {{ item.power_state }}
      IP: {{ item.ip_address | default('Sin IP asignada') }}
      vCPUs: {{ item.num_cpu | default('N/A') }}
      RAM: {{ item.memory_mb | default('N/A') }} MB
  loop: "{{ linux_vms }}"
  tags:
    - vcenter
    - vm-list
    
    # ğŸªŸ Mostrar VMs Windows
- name: "ğŸªŸ VMs WINDOWS"
  debug:
    msg: |
      Nombre: {{ item.guest_name }}
      SO: {{ item.guest_fullname }}
      Estado: {{ item.power_state }}
      IP: {{ item.ip_address | default('Sin IP asignada') }}
      vCPUs: {{ item.num_cpu | default('N/A') }}
      RAM: {{ item.memory_mb | default('N/A') }} MB
  loop: "{{ windows_vms }}"
  tags:
    - vcenter
    - vm-list
    
    # â„¹ï¸ Mostrar VMs Otros
- name: "â„¹ï¸ VMs OTROS"
  debug:
    msg: |
      Nombre: {{ item.guest_name }}
      SO: {{ item.guest_fullname }}
      Estado: {{ item.power_state }}
  loop: "{{ other_vms }}"
  tags:
    - vcenter
    - vm-list
    
    # ğŸ“Š Mostrar resumen
- name: "ğŸ“Š RESUMEN DE VMs"
  debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      RESUMEN DE MÃQUINAS VIRTUALES EN VCENTER/ESXI
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ”Œ Host: {{ vault_vcenter.hostname }}:{{ vault_vcenter.port }}
      ğŸ–¥ï¸  ESXi: {{ vault_vcenter.esxi_hostname_fqdn }}
      
      ğŸ“Š TOTAL: {{ vms_info.virtual_machines | length }} VMs
      
      ğŸ§ Linux: {{ linux_vms | length }} VMs
      {% if linux_vms | length > 0 %}
      {% for vm in linux_vms %}
        â€¢ {{ vm.guest_name }} ({{ vm.power_state }})
      {% endfor %}
      {% endif %}
      
      ğŸªŸ Windows: {{ windows_vms | length }} VMs
      {% if windows_vms | length > 0 %}
      {% for vm in windows_vms %}
        â€¢ {{ vm.guest_name }} ({{ vm.power_state }})
      {% endfor %}
      {% endif %}
      
      â„¹ï¸ Otros: {{ other_vms | length }} VMs
      {% if other_vms | length > 0 %}
      {% for vm in other_vms %}
        â€¢ {{ vm.guest_name }} ({{ vm.power_state }})
      {% endfor %}
      {% endif %}
      
      âš¡ Encendidas: {{ vms_info.virtual_machines | selectattr('power_state', 'equalto', 'poweredOn') | list | length }}
      ğŸ’¤ Apagadas: {{ vms_info.virtual_machines | selectattr('power_state', 'equalto', 'poweredOff') | list | length }}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tags:
    - vcenter
    - summary