---
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  MAIN ROUTER - Punto de Entrada Principal de Ansible       â•‘
# â•‘  VersiÃ³n: 2.0.0 - 100% HashiCorp Vault                      â•‘
# â•‘  Uso: ansible-playbook main.yml -e "mode=vmware"           â•‘
# â•‘  Requiere: Docker con Vault corriendo en puerto 8200       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "ğŸ¯ MAIN ROUTER - OrquestaciÃ³n Centralizada con Vault"
  hosts: localhost
  connection: local
  gather_facts: yes
  become: no
  
  vars:
    # ğŸŒ InformaciÃ³n del Proyecto
    project_name: "Infraestructura Ansible - vCenter"
    project_version: "1.0.0"
    environment: "{{ env | default('staging') }}"
    
    # ğŸ“ Modos de ejecuciÃ³n disponibles
    available_modes:
      - vmware              # GestiÃ³n de vCenter y VMs
      - provisioning        # Provisioning en VMs Linux/Windows
      - monitoring          # Monitoreo de sistemas
      - maintenance         # Tareas de mantenimiento
      - backup              # Respaldos
      - security            # Endurecimiento de seguridad
  
  pre_tasks:
    # ğŸ¨ Banner de inicio
    - name: "ğŸ“Š Mostrar banner de inicio"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         ğŸš€ ANSIBLE MAIN ROUTER - vCenter Edition ğŸš€         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ Proyecto: {{ project_name }}
          â•‘ VersiÃ³n: {{ project_version }}
          â•‘ Ambiente: {{ environment }}
          â•‘ Modo: {{ mode | default('help') | upper }}
          â•‘ Usuario: {{ ansible_user_id }}
          â•‘ Fecha/Hora: {{ ansible_date_time.iso8601 }}
          â•‘ VersiÃ³n Ansible: {{ ansible_version.full }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags:
        - always

    # ğŸ” Validar modo
    - name: "ğŸ” Validar modo de ejecuciÃ³n"
      assert:
        that:
          - mode is defined
          - mode in available_modes
        fail_msg: |
          âŒ ERROR: Modo '{{ mode | default('NO ESPECIFICADO') }}' no vÃ¡lido

          ğŸ“‹ Modos disponibles:
          {% for m in available_modes %}
          âœ“ ansible-playbook main.yml -e "mode={{ m }}"
          {% endfor %}
          
          ğŸ’¡ Ejemplo con ambiente especÃ­fico:
          âœ“ ansible-playbook main.yml -e "mode=vmware env=production"
      tags:
        - always
    
    # ğŸ“š Mostrar ayuda si no hay modo
    - name: "â“ Mostrar ayuda"
      debug:
        msg: |
          â„¹ï¸  AYUDA - USO DEL ROUTER PRINCIPAL:

          ğŸ¯ EJECUCIÃ“N BÃSICA:
          ansible-playbook main.yml -e "mode=vmware"
          ansible-playbook main.yml -e "mode=provisioning"
          ansible-playbook main.yml -e "mode=monitoring"
          ansible-playbook main.yml -e "mode=maintenance"
          ansible-playbook main.yml -e "mode=backup"
          ansible-playbook main.yml -e "mode=security"

          ğŸŒ CON AMBIENTE ESPECÃFICO:
          ansible-playbook main.yml -e "mode=vmware env=production"
          ansible-playbook main.yml -e "mode=provisioning env=staging"

          ğŸ” CON VERBOSIDAD:
          ansible-playbook main.yml -e "mode=vmware" -vv

          âœ… MODO SEGURO (Dry-run):
          ansible-playbook main.yml -e "mode=provisioning" --check

          ğŸ·ï¸  CON TAGS:
          ansible-playbook main.yml -e "mode=vmware" -t vcenter

          ğŸ’¾ SALVAR OUTPUT:
          ansible-playbook main.yml -e "mode=vmware" > output.log 2>&1

          ğŸ”‘ CON VAULT:
          ansible-playbook main.yml -e "mode=vmware" --ask-vault-pass
      when: mode is not defined
      tags:
        - always
  
  tasks:
    # ğŸ”Œ VMWARE - GestiÃ³n de vCenter
    - name: "ğŸ”Œ Ejecutar gestiÃ³n de vCenter"
      include_tasks: playbooks/vmware.yml
      when: mode == 'vmware'
      tags:
        - vmware
        - vcenter
        - infrastructure
    
    # ğŸ“¦ PROVISIONING - Deploy en VMs
    - name: "ğŸ“¦ Ejecutar provisioning"
      include_tasks: playbooks/provisioning.yml
      when: mode == 'provisioning'
      tags:
        - provisioning
        - deploy
        - infrastructure
    
    # ğŸ“Š MONITORING - Monitoreo
    - name: "ğŸ“Š Ejecutar monitoreo"
      include_tasks: playbooks/monitoring.yml
      when: mode == 'monitoring'
      tags:
        - monitoring
        - observability
    
    # ğŸ”§ MAINTENANCE - Mantenimiento
    - name: "ğŸ”§ Ejecutar mantenimiento"
      include_tasks: playbooks/maintenance.yml
      when: mode == 'maintenance'
      tags:
        - maintenance
        - operations
    
    # ğŸ’¾ BACKUP - Respaldos
    - name: "ğŸ’¾ Ejecutar respaldos"
      include_tasks: playbooks/backup.yml
      when: mode == 'backup'
      tags:
        - backup
        - data-protection
    
    # ğŸ” SECURITY - Seguridad
    - name: "ğŸ” Ejecutar endurecimiento de seguridad"
      include_tasks: playbooks/security.yml
      when: mode == 'security'
      tags:
        - security
        - hardening
  
  post_tasks:
    # âœ… Resumen final
    - name: "âœ… Mostrar resumen final"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… EJECUCIÃ“N COMPLETADA CON Ã‰XITO             â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ Modo: {{ mode | upper }}
          â•‘ Ambiente: {{ environment | upper }}
          â•‘ Resultado: SUCCESS âœ“
          â•‘ Fin: {{ ansible_date_time.iso8601 }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags:
        - always