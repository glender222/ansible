---
# ğŸ” PLAYBOOK: IntegraciÃ³n con HashiCorp Vault
# Obtiene credenciales de vCenter desde Vault y lista VMs

- name: "ğŸ” Ansible + HashiCorp Vault - GestiÃ³n de vCenter"
  hosts: localhost
  connection: local
  gather_facts: no
  become: no
  
  vars:
    vault_addr: "http://127.0.0.1:8200"
    vault_token: "root-token"
  
  tasks:
    # ğŸ” Verificar conexiÃ³n a Vault
    - name: "ğŸ” Verificar que Vault estÃ¡ accesible"
      uri:
        url: "{{ vault_addr }}/v1/sys/health"
        method: GET
        status_code: 200
      register: vault_health
      
    - name: "âœ… Vault estÃ¡ listo"
      debug:
        msg: "Vault respondiÃ³ correctamente en {{ vault_addr }}"
    
    # ğŸ”‘ Obtener credenciales desde Vault
    - name: "ğŸ”‘ Obtener credenciales de vCenter desde Vault"
      set_fact:
        vault_vcenter: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=secret/data/vcenter url=' + vault_addr + ' token=' + vault_token) }}"
      
    - name: "ğŸ“‹ Mostrar configuraciÃ³n obtenida (sin password)"
      debug:
        msg:
          - "Hostname: {{ vault_vcenter.hostname }}"
          - "Port: {{ vault_vcenter.port }}"
          - "Username: {{ vault_vcenter.username }}"
          - "ESXi: {{ vault_vcenter.esxi_hostname_fqdn }}"
          - "Datastore: {{ vault_vcenter.datastore }}"
    
    # ğŸ”Œ Conectar a vCenter con credenciales de Vault
    - name: "ğŸ”Œ Conectando a vCenter/ESXi usando credenciales de Vault..."
      debug:
        msg: "Conectando a {{ vault_vcenter.hostname }}:{{ vault_vcenter.port }}"
    
    # ğŸ“‹ Obtener lista de VMs
    - name: "ğŸ“‹ Obtener todas las VMs de vCenter/ESXi"
      community.vmware.vmware_vm_info:
        hostname: "{{ vault_vcenter.hostname }}"
        username: "{{ vault_vcenter.username }}"
        password: "{{ vault_vcenter.password }}"
        port: "{{ vault_vcenter.port }}"
        validate_certs: "{{ vault_vcenter.validate_certs }}"
      register: vms_info
      
    # ğŸ¯ Clasificar VMs
    - name: "ğŸ¯ Clasificar VMs por Sistema Operativo"
      set_fact:
        linux_vms: "{{ vms_info.virtual_machines | selectattr('guest_fullname', 'match', '.*Linux.*') | list }}"
        windows_vms: "{{ vms_info.virtual_machines | selectattr('guest_fullname', 'match', '.*Windows.*') | list }}"
    
    # ğŸ“Š Mostrar resumen
    - name: "ğŸ“Š RESUMEN"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘     ğŸ” CREDENCIALES OBTENIDAS DESDE HASHICORP VAULT       â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ Vault URL: {{ vault_addr }}
          â•‘ vCenter: {{ vault_vcenter.hostname }}:{{ vault_vcenter.port }}
          â•‘ 
          â•‘ ğŸ“Š VMs Detectadas: {{ vms_info.virtual_machines | length }}
          â•‘ ğŸ§ Linux: {{ linux_vms | length }}
          â•‘ ğŸªŸ Windows: {{ windows_vms | length }}
          â•‘ âš¡ Encendidas: {{ vms_info.virtual_machines | selectattr('power_state', 'equalto', 'poweredOn') | list | length }}
          â•‘ ğŸ’¤ Apagadas: {{ vms_info.virtual_machines | selectattr('power_state', 'equalto', 'poweredOff') | list | length }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
